# Fix Service Method Generation Implementation Plan

## Overview

Fix critical issues in `service.go` generation where method names don't match the ServiceInterface and missing stub methods cause compilation failures when using the init template with additional endpoints.

## Current State Analysis

### Issues Discovered

**Issue 1: Method Name Mismatch**
- **ServiceInterface** (in server.go) generates method names using `GenerateOperationName()`:
  - `/v1/users.create` → `UsersCreate`
  - `/v1/users.get` → `UsersGet`
  - `/v1/users.list` → `UsersList`
  - `/v1/users.update` → `UsersUpdate`

- **Service implementation** (in service.go) uses hardcoded method names:
  - `CreateUser`
  - `GetUserById`
  - `ListUsers`
  - `UpdateUser`

- **Result**: Generated code doesn't compile because Service methods don't implement ServiceInterface

**Issue 2: Missing Stub Methods**
- When init template spec contains additional endpoints beyond the 4 base methods
- ServiceInterface includes ALL endpoints
- Service only implements the 4 hardcoded methods
- Additional methods are completely missing
- **Result**: Compilation error - Service doesn't implement ServiceInterface

### Key Discoveries

1. **Operation Name Generation** (`internal/generate/duh/naming.go:9-19`):
   - Parses path `/v1/{subject}.{method}`
   - Returns `{Subject}{Method}` in camel case
   - Example: `/v1/users.create` → `UsersCreate`

2. **Init Template Detection** (`internal/generate/duh/matcher.go:17-43`):
   - Checks if spec contains exactly these 4 paths:
     - `/v1/users.create`
     - `/v1/users.get`
     - `/v1/users.list`
     - `/v1/users.update`
   - Returns true if ALL 4 exist (additional endpoints allowed)

3. **Template Data Structure** (`internal/generate/duh/types.go:31-38`):
   - `Operations []Operation` contains all parsed operations
   - Each `Operation` has `MethodName`, `Path`, `RequestType`, `ResponseType`
   - Currently no way to distinguish init template operations from custom operations

4. **Error Pattern** (from research):
   - Use `duh.NewServiceError(duh.CodeNotImplemented, "MethodName not implemented", nil, nil)`
   - Returns HTTP 501 Not Implemented

## Method Name Mapping

Understanding the current vs. desired state:

| OpenAPI Path | Current Service Method | Correct Service Method | ServiceInterface Method | Needs Change? |
|---|---|---|---|---|
| `/v1/users.create` | `CreateUser` | `UsersCreate` | `UsersCreate` | ✅ YES |
| `/v1/users.get` | `GetUserById` | `UsersGet` | `UsersGet` | ✅ YES |
| `/v1/users.list` | `ListUsers` | `UsersList` | `UsersList` | ✅ YES |
| `/v1/users.update` | `UpdateUser` | `UsersUpdate` | `UsersUpdate` | ✅ YES |
| `/v1/users.delete` | *(missing)* | `UsersDelete` (stub only) | `UsersDelete` | N/A - Test only |

**Key Insights**:
- ServiceInterface (server.go) ALREADY generates correct names. Only service.go and api_test.go.tmpl need fixes.
- ⚠️ **`/v1/users.delete` is NOT part of the init template**: It is used in tests to demonstrate stub generation for extra endpoints. The spec generated by `duh init` contains ONLY the 4 methods: create, get, list, update. Delete should get a stub implementation, not a full one.

## Desired End State

After implementation:

**IMPORTANT**: `service.go` is ONLY generated when using the `--full` flag. Without `--full`, only `server.go`, `client.go`, proto files, and buf config are generated. The template matching logic described below only applies to `--full` flag generation.

### With `--full` Flag

1. **Init Template Spec Only** (`/v1/users.{create,get,list,update}`):
   - Service has 4 methods with full CRUD implementation
   - Method names match ServiceInterface: `UsersCreate`, `UsersGet`, `UsersList`, `UsersUpdate`
   - Tests use correct method names
   - Code compiles without errors

2. **Init Template + Extra Endpoints** (e.g., adding `/v1/users.delete` for testing):
   - Service has 4 methods with full implementation (same as above)
   - Additional methods have stub implementations returning `CodeNotImplemented`
   - Example: `UsersDelete` would get a stub, not full implementation
   - All methods match ServiceInterface names
   - Tests verify stubs return appropriate errors
   - Code compiles without errors
   - **Note**: This scenario is for testing purposes. The standard `duh init` spec has only 4 endpoints.

3. **Custom Spec (No Init Template)**:
   - All methods have stub implementations
   - All method names match ServiceInterface
   - Test template generates basic test for first operation
   - Code compiles without errors

### Without `--full` Flag

- `service.go` is NOT generated
- Only generates: `server.go`, `client.go`, iterator.go (if list ops), proto files, buf config
- No changes to this behavior

## Breaking Changes

⚠️ **This is a BREAKING CHANGE** - Generated service method names will change:

**Before:**
```go
func (s *Service) CreateUser(ctx context.Context, req *pb.CreateUserRequest, resp *pb.CreateUserResponse) error
func (s *Service) GetUserById(ctx context.Context, req *pb.GetUserRequest, resp *pb.UserResponse) error
func (s *Service) ListUsers(ctx context.Context, req *pb.ListUsersRequest, resp *pb.ListUsersResponse) error
func (s *Service) UpdateUser(ctx context.Context, req *pb.UpdateUserRequest, resp *pb.UpdateUserResponse) error
```

**After:**
```go
func (s *Service) UsersCreate(ctx context.Context, req *pb.CreateUserRequest, resp *pb.CreateUserResponse) error
func (s *Service) UsersGet(ctx context.Context, req *pb.GetUserRequest, resp *pb.UserResponse) error
func (s *Service) UsersList(ctx context.Context, req *pb.ListUsersRequest, resp *pb.ListUsersResponse) error
func (s *Service) UsersUpdate(ctx context.Context, req *pb.UpdateUserRequest, resp *pb.UpdateUserResponse) error
```

Users who have existing generated code will need to regenerate all files.

### Verification Commands

```bash
# Generate with init template + extra endpoint
go test ./internal/generate/duh -run TestGenerateDuhWithFullFlagAndExtraEndpoint

# Verify existing tests still pass
go test ./internal/generate/duh -run TestGenerateDuhWithFullFlagAndInitSpec
go test ./internal/generate/duh -run TestGenerateDuhWithFullFlagAndCustomSpec
```

## What We're NOT Doing

- Not changing the operation name generation logic
- Not modifying how paths are parsed from OpenAPI specs
- Not changing client.go generation (it already works correctly)
- Not modifying server.go or handler generation
- Not changing the init template detection algorithm
- Not adding new error codes or error handling patterns
- Not modifying daemon.go or Makefile generation
- **Not adding `/v1/users.delete` to the init template** - it remains a 4-method template (create, get, list, update). Delete is only used in tests to verify stub generation works.

## Implementation Approach

Use a **flagging approach** where each Operation is marked during parsing to indicate whether it matches one of the 4 init template methods. Templates check this flag to determine whether to generate full implementation or stub.

**Why this approach:**
- Minimal changes to data structures
- Clear boolean semantics in templates
- Keeps all operations in one unified list
- Easy to test and verify
- No breaking changes to existing code paths

## Phase 1: Add Init Template Method Detection

### Overview
Add capability to identify which operations correspond to the 4 init template methods during parsing.

### Changes Required

#### 1. Operation Struct Enhancement
**File**: `internal/generate/duh/types.go`

```go
type Operation struct {
	MethodName          string
	Path                string
	ConstName           string
	Summary             string
	RequestType         string
	ResponseType        string
	IsInitTemplateMethod bool  // NEW FIELD
}
```

**Field Purpose:**
- `IsInitTemplateMethod`: true if this operation's path matches one of the 4 init template paths

#### 2. Parser Enhancement
**File**: `internal/generate/duh/parser.go`

**Function to create**: `isInitTemplateMethod(path string) bool`

```go
// isInitTemplateMethod checks if the given path is one of the 4 init template paths
func isInitTemplateMethod(path string) bool
```

**Function Responsibilities:**
- Check if path equals `/v1/users.create`, `/v1/users.get`, `/v1/users.list`, or `/v1/users.update`
- Return true if match found, false otherwise
- Reference existing pattern: See `IsInitTemplateSpec()` at `matcher.go:17-43`

**Modifications to**: `extractOperations()` (line 60)

Add after line 136 (where Operation struct is created):
```go
operations = append(operations, Operation{
	MethodName:          operationName,
	Path:                path,
	ConstName:           GenerateConstName(operationName),
	Summary:             summary,
	RequestType:         requestType,
	ResponseType:        responseType,
	IsInitTemplateMethod: p.isFullTemplate && isInitTemplateMethod(path),  // NEW LINE
})
```

**Logic**:
- Set `IsInitTemplateMethod = true` ONLY when BOTH conditions are met:
  1. `p.isFullTemplate` is true (the overall spec matches init template pattern)
  2. `isInitTemplateMethod(path)` returns true (this specific path is one of the 4 init template paths)
- This ensures that if someone uses a custom spec with a path that happens to match (unlikely but possible), it won't get full implementation

**Testing Requirements:**

```go
// New test function
func TestIsInitTemplateMethod(t *testing.T)
```

**Test Objectives:**
- Verify returns true for all 4 init template paths
- Verify returns false for other paths like `/v1/products.create`
- Verify case sensitivity

**Existing tests that may require updates:**
- `TestGenerateDuhWithFullFlagAndInitSpec` - May need assertions verifying flag is set
- No modifications expected to existing test logic

**Context for implementation:**
- Follow error handling pattern from `parseSubjectMethod()` at line 25
- Use similar path matching logic to `IsInitTemplateSpec()` at `matcher.go:22-40`

## Phase 2: Update Service Template

### Overview
Refactor service.go.tmpl to generate methods by iterating through Operations and checking the IsInitTemplateMethod flag.

### Changes Required

#### 1. Service Template Refactoring
**File**: `internal/generate/duh/templates/service.go.tmpl`

**Current Structure (lines 26-229):**
- Hardcoded if/else based on `.IsFullTemplate`
- Full template branch has 4 hardcoded methods with custom names
- Stub template branch iterates `.Operations` correctly

**Complete New Structure:**

The template will follow this pattern:
1. Service struct definition (with/without users map based on IsFullTemplate)
2. NewService constructor
3. Range over all Operations
4. For each operation, check IsInitTemplateMethod flag
5. If true, use nested if to match path and generate full implementation
6. If false, generate stub
7. Shutdown method

**Detailed Template Structure:**

```go
type Service struct {
{{if .IsFullTemplate}}	users map[string]*pb.UserResponse
	mutex sync.RWMutex
{{end}}	conf  ServiceConfig
}

func NewService(conf ServiceConfig) (ServiceInterface, error) {
{{if .IsFullTemplate}}	set.Default(&conf.Log, slog.Default())

	return &Service{
		users: make(map[string]*pb.UserResponse),
		conf:  conf,
	}, nil
{{else}}	return &Service{conf: conf}, nil
{{end}}}

{{range .Operations}}
{{if .IsInitTemplateMethod}}
  {{if eq .Path "/v1/users.create"}}
func (s *Service) {{.MethodName}}(ctx context.Context, req *{{.RequestType}}, resp *{{.ResponseType}}) error {
	// [INSERT FULL CREATE LOGIC FROM CURRENT LINES 42-76]
	// Validation, mutex lock, duplicate check, UUID generation, etc.
	return nil
}
  {{else if eq .Path "/v1/users.get"}}
func (s *Service) {{.MethodName}}(ctx context.Context, req *{{.RequestType}}, resp *{{.ResponseType}}) error {
	// [INSERT FULL GET LOGIC FROM CURRENT LINES 80-98]
	// Validation, mutex read lock, retrieve from map, populate response
	return nil
}
  {{else if eq .Path "/v1/users.list"}}
func (s *Service) {{.MethodName}}(ctx context.Context, req *{{.RequestType}}, resp *{{.ResponseType}}) error {
	// [INSERT FULL LIST LOGIC FROM CURRENT LINES 102-154]
	// Mutex read lock, pagination, sorting, response population
	return nil
}
  {{else if eq .Path "/v1/users.update"}}
func (s *Service) {{.MethodName}}(ctx context.Context, req *{{.RequestType}}, resp *{{.ResponseType}}) error {
	// [INSERT FULL UPDATE LOGIC FROM CURRENT LINES 158-199]
	// Validation, mutex lock, update fields, duplicate email check
	return nil
}
  {{end}}
{{else}}
// This branch handles all non-init-template methods (e.g., UsersDelete, any custom endpoints)
func (s *Service) {{.MethodName}}(ctx context.Context, req *{{.RequestType}}, resp *{{.ResponseType}}) error {
	return duh.NewServiceError(duh.CodeNotImplemented, "{{.MethodName}} not implemented", nil, nil)
}
{{end}}
{{end}}

func (s *Service) Shutdown(ctx context.Context) error {
{{if .IsFullTemplate}}	s.mutex.Lock()
	defer s.mutex.Unlock()

	s.conf.Log.Info("Shutting down service", "users", len(s.users))
	s.users = nil
{{else}}	// TODO: Cleanup resources
{{end}}	return nil
}
```

**Implementation Notes:**
- **CRITICAL**: The full implementation bodies (marked with [INSERT...]) should be copied EXACTLY from the current service.go.tmpl
- Only change: Replace hardcoded method names in comments/errors with `{{.MethodName}}`
- Keep all validation logic, mutex operations, business logic identical
- The nested `{{if eq .Path ...}}` checks ensure correct implementation is used for each init template method

**Testing Requirements:**

**Existing tests that require updates:**
```go
func TestGenerateDuhWithFullFlagAndInitSpec(t *testing.T)  // Line 15
func TestGenerateDuhWithFullFlagAndCustomSpec(t *testing.T) // Line 80
```

**Updates needed:**
- Change assertions from `"func (s *Service) CreateUser"` to `"func (s *Service) UsersCreate"`
- Change assertions from `"func (s *Service) GetUserById"` to `"func (s *Service) UsersGet"`
- Change assertions from `"func (s *Service) UpdateUser"` to `"func (s *Service) UsersUpdate"`
- Keep assertions for `"func (s *Service) ListUsers"` (name already matches)

**New test** (already created):
```go
func TestGenerateDuhWithFullFlagAndExtraEndpoint(t *testing.T)
```
- Located at: `internal/generate/duh/full_test.go:542`
- Should pass after implementation

**Context for implementation:**
- Reference client.go.tmpl lines 63-78 for correct iteration pattern over Operations
- Reference existing stub generation at service.go.tmpl lines 219-223
- Keep the full implementation logic exactly as-is, only change method names

## Phase 3: Update Test Template

### Overview
Fix api_test.go.tmpl to use correct Operation-based method names instead of hardcoded names.

### Changes Required

#### 1. Test Template Client Method Calls
**File**: `internal/generate/duh/templates/api_test.go.tmpl`

**Current Issues:**
- Lines 27, 71, 89, 96, 115, 123, 144, 162, 182, 304, 324, 333, 356, 408: Use hardcoded method names
  - `c.CreateUser` (should be `c.UsersCreate`)
  - `c.GetUserById` (should be `c.UsersGet`)
  - `c.ListUsers` (should be `c.UsersList`)
  - `c.UpdateUser` (should be `c.UsersUpdate`)

**Chosen Approach: Template Variables**

Define method name variables at the top of the `{{if .IsFullTemplate}}` block, then use them throughout:

```go
{{if .IsFullTemplate}}
{{- $createMethod := "" -}}
{{- $getMethod := "" -}}
{{- $listMethod := "" -}}
{{- $updateMethod := "" -}}
{{- range .Operations -}}
  {{- if eq .Path "/v1/users.create" -}}{{- $createMethod = .MethodName -}}{{- end -}}
  {{- if eq .Path "/v1/users.get" -}}{{- $getMethod = .MethodName -}}{{- end -}}
  {{- if eq .Path "/v1/users.list" -}}{{- $listMethod = .MethodName -}}{{- end -}}
  {{- if eq .Path "/v1/users.update" -}}{{- $updateMethod = .MethodName -}}{{- end -}}
{{- end -}}

func TestCreateUser(t *testing.T) {
	// ... test setup ...
	err = c.{{$createMethod}}(ctx, &pb.CreateUserRequest{
		Name:  "Alice",
		Email: "alice@example.com",
	}, &resp)
	// ... assertions ...
}
```

**Implementation Steps:**
1. Add the 4 template variable definitions at line 16 (after `{{if .IsFullTemplate}}`)
2. Find/replace ALL occurrences:
   - `c.CreateUser` → `c.{{$createMethod}}`
   - `c.GetUserById` → `c.{{$getMethod}}`
   - `c.ListUsers` → `c.{{$listMethod}}`
   - `c.UpdateUser` → `c.{{$updateMethod}}`
3. This includes occurrences in test names that construct method calls

**Why this approach:**
- Clean, readable template code
- Variables defined once, used many times
- No nested template logic in method calls
- Template-only solution, no Go code changes needed

**Testing Requirements:**

**Existing tests that may require updates:**
```go
func TestGenerateDuhWithFullFlagAndInitSpec(t *testing.T)  // full_test.go:15
```

**May need:**
- Verify generated api_test.go compiles
- Run generated tests to ensure they use correct method names

**No new test signatures required** - fixing existing functionality

**Context for implementation:**
- Template syntax reference: Go text/template package
- Pattern: Look at how daemon.go.tmpl references Operations
- Keep all test logic identical, only change method name resolution

## Phase 4: Validation and Testing

### Overview
Comprehensive testing to verify all scenarios work correctly.

### Changes Required

#### 1. Update Existing Tests
**File**: `internal/generate/duh/full_test.go`

**Test modifications needed:**

`TestGenerateDuhWithFullFlagAndInitSpec` (`full_test.go:15`):

Current assertions (lines 56-60):
```go
assert.Contains(t, string(serviceContent), "map[string]*pb.UserResponse")
assert.Contains(t, string(serviceContent), "func (s *Service) CreateUser")
assert.Contains(t, string(serviceContent), "func (s *Service) GetUserById")
assert.Contains(t, string(serviceContent), "func (s *Service) ListUsers")
assert.Contains(t, string(serviceContent), "func (s *Service) UpdateUser")
```

Change to:
```go
assert.Contains(t, string(serviceContent), "map[string]*pb.UserResponse")
assert.Contains(t, string(serviceContent), "func (s *Service) UsersCreate")
assert.Contains(t, string(serviceContent), "func (s *Service) UsersGet")
assert.Contains(t, string(serviceContent), "func (s *Service) UsersList")
assert.Contains(t, string(serviceContent), "func (s *Service) UsersUpdate")
```

`TestGenerateDuhWithFullFlagAndCustomSpec` (`full_test.go:80`):

Current assertion (line 107):
```go
assert.Contains(t, string(serviceContent), "CodeNotImplemented")
```

Add assertion:
```go
assert.Contains(t, string(serviceContent), "func (s *Service) ProductsCreate")
assert.Contains(t, string(serviceContent), "CodeNotImplemented")
```

#### 2. Verify New Test Passes
**File**: `internal/generate/duh/full_test.go`

**Test**: `TestGenerateDuhWithFullFlagAndExtraEndpoint` (line 542)
- Should pass after implementation
- Uses init template spec + `/v1/users.delete` endpoint (added specifically to test stub generation)
- Verifies init template methods work with correct names (UsersCreate, UsersGet, UsersList, UsersUpdate)
- Verifies extra method (UsersDelete) gets stub implementation (not full implementation)
- Verifies ServiceInterface and Service method names match
- Verifies stub returns CodeNotImplemented error with correct message
- **Note**: Delete endpoint is NOT part of standard `duh init` template - it's added only for testing

#### 3. Integration Test
**Manual verification steps:**

```bash
# Create test directory
mkdir -p /tmp/duh-test && cd /tmp/duh-test

# Create OpenAPI spec with init template + extra method
cat > openapi.yaml << EOF
[init template spec with /v1/users.delete added]
EOF

# Create go.mod
cat > go.mod << EOF
module github.com/test/example
go 1.24
EOF

# Generate code
duh generate duh openapi.yaml --full

# Verify compilation
go mod tidy
go build .

# Run tests
go test ./...
```

**Expected results:**
- All files generate without errors
- Code compiles successfully
- Service implements ServiceInterface
- Tests pass for implemented methods
- Stub methods return NotImplemented errors

### Testing Requirements

**New test already created:**
- `TestGenerateDuhWithFullFlagAndExtraEndpoint` at `full_test.go:542`

**Existing tests requiring verification:**
- `TestGenerateDuhWithFullFlagAndInitSpec` - verify method names updated
- `TestGenerateDuhWithFullFlagAndCustomSpec` - verify stubs work for custom specs
- `TestGeneratedServerStructure` - should pass unchanged
- `TestServerWithMultipleOperations` - should pass unchanged

**Validation commands:**
```bash
go test ./internal/generate/duh -v
go test ./internal/generate/duh -run TestGenerateDuhWithFullFlagAndExtraEndpoint
```

### Context for Implementation

**Phase Completion Criteria:**
- All existing tests pass with updated assertions
- New test passes
- Manual integration test succeeds
- Generated code compiles and runs
- No regressions in client or server generation

## Implementation Notes

### Critical Considerations

1. **Template Syntax**: Go templates use `{{range}}...{{end}}` for iteration, `{{if}}...{{end}}` for conditionals
2. **Method Name Consistency**: All generated names must use `GenerateOperationName()` output
3. **Backward Compatibility**: Custom specs (non-init) should behave identically
4. **Error Messages**: Stub implementations must include method name in error message

### Patterns to Follow

**Operation Iteration**:
```go
{{range .Operations}}
  // Access .MethodName, .Path, .RequestType, .ResponseType, .IsInitTemplateMethod
{{end}}
```

**Conditional Logic**:
```go
{{if .IsInitTemplateMethod}}
  // Full implementation
{{else}}
  // Stub implementation
{{end}}
```

**Path Matching**:
```go
{{if eq .Path "/v1/users.create"}}
  // Specific logic for this endpoint
{{end}}
```

### Testing Strategy

**Unit Tests:**
- Test `isInitTemplateMethod()` function directly
- Verify Operation structs have correct flag values

**Integration Tests:**
- Generate code with various OpenAPI specs
- Verify compilation succeeds
- Verify method names match across files

**Functional Tests:**
- Run generated tests to verify behavior
- Test stub methods return correct error codes
- Test full methods work as expected

## Success Criteria

Implementation is complete when:

1. ✅ `TestGenerateDuhWithFullFlagAndExtraEndpoint` passes
2. ✅ All existing tests pass with updated assertions
3. ✅ Generated service.go methods match ServiceInterface signatures
4. ✅ Init template methods have full implementations
5. ✅ Non-init methods have stub implementations
6. ✅ api_test.go uses correct client method names
7. ✅ Generated code compiles without errors
8. ✅ Manual integration test succeeds
